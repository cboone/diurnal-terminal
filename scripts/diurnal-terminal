#!/bin/bash
# shellcheck disable=SC2199
# set -x

readonly command_run_time=$(date '+%H:%M:%S')
readonly script_name=$(basename "$0")
readonly homebrew_prefix=${HOMEBREW_PREFIX:-$(brew --prefix)}
readonly plist_name="homebrew.mxcl.$script_name"
readonly args=( "$@" )
readonly usage=$(cat <<EOF
$script_name: Automatically switch Terminal themes at sunrise and sunset

Usage:
  $script_name (-h|--help)          Show this screen
  $script_name --overwrite-plist    Create new plist scheduled for the next event
  $script_name --print-plist        Print plist scheduled for the next event
  $script_name --restart-agent      Kickstart the LaunchAgent
  $script_name --update-theme       Ensure current theme is set correctly

Options:
  -v|--verbose                          Log output
  --debug                               Log more output
  --time HH:MM:SS                       Override trigger time (for plist generation)
  --day-theme THEME                     Override day theme from config
  --night-theme THEME                   Override night theme from config
EOF
)

[[ " ${args[@]} " =~ ( --debug ) ]] && readonly debug=debug
debug() { [[ $debug ]] && echo "$@" >&2; }
[[ " ${args[@]} " =~ ( --verbose | -v ) ]] && readonly verbose=verbose
log() { [[ $verbose || $debug ]] && echo "$@" >&2; }
die() { echo "$@"; exit 1; }
custom_time=""
day_theme=""
night_theme=""

# Parse theme overrides early (before config is read)
for ((index=0; index<${#args[@]}; index++)); do
  case "${args[index]}" in
    --day-theme)   day_theme="${args[index+1]}" ;;
    --night-theme) night_theme="${args[index+1]}" ;;
    --time)        custom_time="${args[index+1]}" ;;
  esac
done

# shellcheck disable=SC2199
if (( $# == 0 )) || [[ " ${args[@]} " =~ ( --help | -h ) ]]; then
  # printf '%s\n\n' "$usage"
  # exit 1
  die "$usage" '\n\n'
fi

# https://stackoverflow.com/questions/10929453/read-a-file-line-by-line-assigning-the-value-to-a-variable
config="$HOME/.config/$script_name.conf"
[[ ! -e $config ]] && die "Config not found: $config"
debug "$config"
debug "$(cat "$config")"
debug ''
while IFS='' read -r line || [[ -n "$line" ]]; do
  readonly "$line"
done < "$config"

# Apply command-line overrides
readonly effective_day_theme="${day_theme:-$DAY_THEME}"
readonly effective_night_theme="${night_theme:-$NIGHT_THEME}"

readonly heliocron_output=$("$homebrew_prefix"/bin/heliocron --latitude "$LATITUDE" --longitude "$LONGITUDE" report)
debug "$heliocron_output"
debug ''
readonly sunrise_time=${heliocron_output:20:8}
readonly sunset_time=${heliocron_output:55:8}
# Compare only HH:MM to avoid timing edge cases when triggered at exact second
readonly current_hhmm=${command_run_time:0:5}
readonly sunrise_hhmm=${sunrise_time:0:5}
readonly sunset_hhmm=${sunset_time:0:5}
if [[ $current_hhmm < $sunset_hhmm ]] && \
   [[ ! $current_hhmm < $sunrise_hhmm ]]; then
    readonly event=sunset
    readonly current_theme=$effective_day_theme
    readonly next_theme=$effective_night_theme
    readonly next_time=$sunset_time
else
  readonly event=sunrise
  readonly current_theme=$effective_night_theme
  readonly next_theme=$effective_day_theme
  readonly next_time=$sunrise_time
fi

readonly cellar="${HOMEBREW_CELLAR:-"$homebrew_prefix/Cellar"}/$script_name"
readonly latest="$(find "$cellar" -maxdepth 1 -type d | sort -nr | head -n 1)"

overwrite_plist() {
  readonly home_plist="$HOME/Library/LaunchAgents/$plist_name.plist"
  print_plist | tee "$home_plist"
}

print_plist() {
  readonly template="$latest/share/$plist_name.template.plist"
  [[ ! -e $template ]] && die "plist template not found: $template"

  local schedule_time="${custom_time:-$next_time}"
  local theme_args=""

  if [[ -n $day_theme ]]; then
    theme_args+="    <string>--day-theme</string>
    <string>$day_theme</string>
"
  fi
  if [[ -n $night_theme ]]; then
    theme_args+="    <string>--night-theme</string>
    <string>$night_theme</string>
"
  fi

  if [[ -n $custom_time ]]; then
    log "Scheduling for $custom_time"
  else
    log "Switching to $next_theme at $event ($next_time)"
  fi

  m4 -DHOUR="${schedule_time:0:2}" \
     -DMINUTE="${schedule_time:3:2}" \
     -DSECOND="${schedule_time:6:2}" \
     -DBIN_PATH="$homebrew_prefix/bin/$script_name" \
     -DPLIST_LABEL="$plist_name" \
     -DTHEME_ARGS="$theme_args" \
     -DRUN_AT_LOAD="<true/>" \
     "$template"
}

restart_agent() {
  local plist_path="$HOME/Library/LaunchAgents/$plist_name.plist"
  local domain="gui/$(id -u)"
  local log_file="/tmp/$plist_name.log"

  log "Reloading LaunchAgent for next event"

  # Background the reload to avoid killing ourselves while running
  (
    sleep 1
    launchctl bootout "$domain/$plist_name" 2>>"$log_file" || true
    if ! launchctl bootstrap "$domain" "$plist_path" 2>>"$log_file"; then
      echo "ERROR: Failed to bootstrap LaunchAgent" >>"$log_file"
    fi
  ) &
  disown
}

update_theme() {
  log "Switching to $current_theme"
  osascript "$homebrew_prefix"/bin/switch-terminal-theme "$current_theme"
}

while (( $# > 0 )); do
  case $1 in
  --overwrite-plist)
    overwrite_plist
    shift
    ;;
  --print-plist)
    print_plist
    shift
    ;;
  --restart-agent)
    restart_agent
    shift
    ;;
  --update-theme)
    update_theme
    shift
    ;;
  --time)
    custom_time="$2"
    shift 2
    ;;
  --day-theme)
    day_theme="$2"
    shift 2
    ;;
  --night-theme)
    night_theme="$2"
    shift 2
    ;;
  *)
    shift
    ;;
  esac
done