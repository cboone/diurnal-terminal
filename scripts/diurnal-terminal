#!/bin/bash
# shellcheck disable=SC2199
# set -x

readonly command_run_time=$(date '+%H:%M:%S')
readonly script_name=$(basename "$0")
readonly homebrew_prefix=${HOMEBREW_PREFIX:-$(brew --prefix)}
readonly plist_name="homebrew.mxcl.$script_name"
readonly usage=$(cat <<EOF
$script_name: Automatically switch Terminal themes at sunrise and sunset

Usage:
  $script_name (-h|--help)          Show this screen
  $script_name --overwrite-plist    Create new plist scheduled for the next event
  $script_name --print-plist        Print plist scheduled for the next event
  $script_name --restart-agent      Kickstart the LaunchAgent
  $script_name --update-theme       Ensure current theme is set correctly

Options:
  -v|--verbose                          Log output
  --debug                               Log more output
  --day-theme THEME                     Override day theme from config
  --night-theme THEME                   Override night theme from config
  --time HH:MM:SS                       Override trigger time (for plist generation)
EOF
)

# Parse flags that affect logging
[[ " $* " =~ " --debug " ]] && readonly debug=debug
debug() { [[ $debug ]] && echo "$@" >&2; }
[[ " $* " =~ ( --verbose | -v ) ]] && readonly verbose=verbose
log() { [[ $verbose || $debug ]] && echo "$@" >&2; }
die() { echo "$@"; exit 1; }

# shellcheck disable=SC2199
if (( $# == 0 )) || [[ " $* " =~ ( --help | -h ) ]]; then
  die "$usage" '\n\n'
fi

# Parse all arguments first
custom_time=""
day_theme=""
night_theme=""
do_overwrite_plist=false
do_print_plist=false
do_restart_agent=false
do_update_theme=false

while (( $# > 0 )); do
  case $1 in
  --day-theme)       day_theme="$2"; shift 2 ;;
  --night-theme)     night_theme="$2"; shift 2 ;;
  --overwrite-plist) do_overwrite_plist=true; shift ;;
  --print-plist)     do_print_plist=true; shift ;;
  --restart-agent)   do_restart_agent=true; shift ;;
  --time)            custom_time="$2"; shift 2 ;;
  --update-theme)    do_update_theme=true; shift ;;
  *)                 shift ;;
  esac
done

# Read config
config="$HOME/.config/$script_name.conf"
[[ ! -e $config ]] && die "Config not found: $config"
debug "$config"
debug "$(cat "$config")"
debug ''
while IFS='' read -r line || [[ -n "$line" ]]; do
  readonly "$line"
done < "$config"

# Apply command-line overrides
readonly effective_day_theme="${day_theme:-$DAY_THEME}"
readonly effective_night_theme="${night_theme:-$NIGHT_THEME}"

# Calculate sun times
readonly heliocron_output=$("$homebrew_prefix"/bin/heliocron --latitude "$LATITUDE" --longitude "$LONGITUDE" report)
debug "$heliocron_output"
debug ''
readonly sunrise_time=${heliocron_output:20:8}
readonly sunset_time=${heliocron_output:55:8}

# Determine current theme based on time of day
readonly current_hhmm=${command_run_time:0:5}
readonly sunrise_hhmm=${sunrise_time:0:5}
readonly sunset_hhmm=${sunset_time:0:5}
if [[ $current_hhmm < $sunset_hhmm ]] && \
   [[ ! $current_hhmm < $sunrise_hhmm ]]; then
  readonly event=sunset
  readonly current_theme=$effective_day_theme
  readonly next_theme=$effective_night_theme
  readonly next_time=$sunset_time
else
  readonly event=sunrise
  readonly current_theme=$effective_night_theme
  readonly next_theme=$effective_day_theme
  readonly next_time=$sunrise_time
fi

readonly cellar="${HOMEBREW_CELLAR:-"$homebrew_prefix/Cellar"}/$script_name"
readonly latest="$(find "$cellar" -maxdepth 1 -type d | sort -nr | head -n 1)"

# Functions
overwrite_plist() {
  readonly home_plist="$HOME/Library/LaunchAgents/$plist_name.plist"
  print_plist | tee "$home_plist"
}

print_plist() {
  readonly template="$latest/share/$plist_name.template.plist"
  [[ ! -e $template ]] && die "plist template not found: $template"

  local schedule_time="${custom_time:-$next_time}"
  local theme_args=""

  if [[ -n $day_theme ]]; then
    theme_args+="    <string>--day-theme</string>
    <string>$day_theme</string>
"
  fi
  if [[ -n $night_theme ]]; then
    theme_args+="    <string>--night-theme</string>
    <string>$night_theme</string>
"
  fi

  if [[ -n $custom_time ]]; then
    log "Scheduling for $custom_time"
  else
    log "Switching to $next_theme at $event ($next_time)"
  fi

  # Strip leading zeros to avoid octal interpretation (08 and 09 are invalid octal)
  local hour=$((10#${schedule_time:0:2}))
  local minute=$((10#${schedule_time:3:2}))
  local second=$((10#${schedule_time:6:2}))

  m4 -DHOUR="$hour" \
     -DMINUTE="$minute" \
     -DSECOND="$second" \
     -DBIN_PATH="$homebrew_prefix/bin/$script_name" \
     -DPLIST_LABEL="$plist_name" \
     -DTHEME_ARGS="$theme_args" \
     "$template" | tr -s '\n'  # Remove consecutive blank lines that cause launchd bootstrap to fail
}

restart_agent() {
  local plist_path="$HOME/Library/LaunchAgents/$plist_name.plist"
  local domain="gui/$(id -u)"
  local log_file="/tmp/$plist_name.log"

  log "Reloading LaunchAgent for next event"

  # Use nohup to ensure reload survives after script exits (important when run via LaunchAgent)
  nohup bash -c "
    echo '[restart_agent] Starting reload subprocess' >>$log_file
    sleep 2
    echo '[restart_agent] Executing bootout' >>$log_file
    launchctl bootout $domain/$plist_name 2>>$log_file || true
    echo '[restart_agent] Executing bootstrap' >>$log_file
    launchctl bootstrap $domain $plist_path 2>>$log_file
    echo '[restart_agent] Bootstrap exit code: \$?' >>$log_file
  " </dev/null >/dev/null 2>&1 &

  log "Spawned reload subprocess (PID: $!)"
}

update_theme() {
  log "Switching to $current_theme"
  osascript "$homebrew_prefix"/bin/switch-terminal-theme "$current_theme"
}

# Execute commands
$do_overwrite_plist && overwrite_plist
$do_print_plist && print_plist
$do_restart_agent && restart_agent
$do_update_theme && update_theme
true  # Ensure script exits with 0
